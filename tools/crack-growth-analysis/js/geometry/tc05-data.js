/**
 * NASGRO TC05 Data Tables
 * Transcribed from Appendix C
 */

const TC05_DATA = {
    // Table C4: Stress Intensity Correction Factors (Tension, One Crack, .0055 <= D/B <= .1)
    // Note: The header says .0055 <= D/B <= .1 but the table uses D/H. H is hole spacing.
    // Rows: D/H, Cols: c/(H-D)
    C4: {
        cols: [0.0, 0.01, 0.05, 0.1, 0.15, 0.2, 0.4, 0.6, 0.8, 0.9, 0.95, 0.99],
        rows: [0.05, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.75, 0.80, 0.85, 0.90],
        data: [
            [2.858, 1.782, 1.043, .8898, .8338, .8058, .7648, .7581, .7681, .7876, .8244, 1.065],
            [2.921, 2.195, 1.327, 1.065, .9595, .9054, .8222, .8017, .8122, .8514, .9296, 1.333],
            [2.965, 2.574, 1.793, 1.410, 1.230, 1.126, .9590, .9141, .9386, 1.033, 1.197, 1.828],
            [3.101, 2.796, 2.167, 1.761, 1.534, 1.391, 1.141, 1.074, 1.126, 1.281, 1.516, 2.366],
            [3.219, 3.009, 2.520, 2.134, 1.888, 1.719, 1.395, 1.308, 1.399, 1.617, 1.922, 2.940],
            [3.474, 3.299, 2.922, 2.575, 2.328, 2.145, 1.765, 1.664, 1.809, 2.111, 2.538, 3.656],
            [3.886, 3.786, 3.461, 3.162, 2.933, 2.752, 2.342, 2.238, 2.443, 2.858, 3.424, 4.550],
            [4.878, 4.585, 4.344, 4.091, 3.899, 3.735, 3.343, 3.260, 3.561, 4.153, 4.906, 5.932],
            [5.331, 5.272, 5.056, 4.852, 4.663, 4.523, 4.170, 4.118, 4.501, 5.251, 6.108, 7.054],
            [6.382, 6.335, 6.182, 5.934, 5.798, 5.690, 5.429, 5.432, 5.947, 6.850, 7.720, 8.517],
            [8.265, 8.202, 8.036, 7.776, 7.678, 7.619, 7.513, 7.671, 8.353, 9.392, 10.11, 10.66],
            [11.78, 11.54, 11.45, 11.17, 11.10, 11.10, 11.49, 12.12, 13.38, 14.36, 14.61, 14.90]
        ]
    },

    // Table C5: Stress Intensity Correction Factors (Pin Loading, One Crack, D/B=.1)
    C5: {
        cols: [0.0, 0.01, 0.05, 0.1, 0.15, 0.2, 0.4, 0.6, 0.8, 0.9, 0.95, 0.99],
        rows: [0.05, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.75, 0.80, 0.85, 0.90],
        data: [
            [.9805, .4358, .1353, .0721, .0521, .0425, .0297, .0275, .0292, .0331, .0402, .0755],
            [1.062, .6693, .2793, .1657, .1220, .0994, .0671, .0592, .0607, .0706, .0886, .1657],
            [1.243, .9904, .5774, .3898, .3016, .2512, .1701, .1480, .1548, .1860, .2362, .4063],
            [1.455, 1.275, .8898, .6604, .5349, .4568, .3199, .2816, .3005, .3618, .4502, .7480],
            [1.733, 1.589, 1.242, .9926, .8388, .7350, .5372, .4812, .5212, .6225, .7614, 1.205],
            [2.089, 1.971, 1.670, 1.420, 1.248, 1.124, .8648, .7917, .8661, 1.033, 1.295, 1.845],
            [2.609, 2.542, 2.251, 2.015, 1.836, 1.701, 1.391, 1.307, 1.432, 1.693, 2.042, 2.734],
            [3.522, 3.412, 3.175, 2.962, 2.793, 2.657, 2.329, 2.250, 2.461, 2.883, 3.416, 4.145],
            [4.188, 4.096, 3.895, 3.696, 3.553, 3.426, 3.118, 3.059, 3.345, 3.912, 4.559, 5.265],
            [5.214, 5.209, 5.003, 4.803, 4.676, 4.574, 4.330, 4.315, 4.721, 5.444, 6.143, 6.783],
            [7.085, 7.042, 6.889, 6.642, 6.540, 6.481, 6.392, 6.507, 7.161, 8.069, 8.685, 9.029],
            [10.53, 10.35, 10.29, 10.23, 10.14, 10.15, 10.47, 11.05, 12.21, 13.10, 13.52, 14.01]
        ]
    },

    // Table C6: Stress Intensity Correction Factors (Tension, Two Cracks, .0055 <= D/B <= .1)
    C6: {
        cols: [0.0, 0.01, 0.05, 0.1, 0.15, 0.2, 0.4, 0.6, 0.8, 0.9, 0.95, 0.99],
        rows: [0.05, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.75, 0.80, 0.85, 0.90],
        data: [
            [2.858, 1.854, 1.247, 1.131, 1.093, 1.075, 1.068, 1.101, 1.174, 1.245, 1.332, 1.760],
            [2.921, 2.229, 1.476, 1.267, 1.189, 1.151, 1.110, 1.136, 1.215, 1.382, 1.476, 2.172],
            [2.965, 2.583, 1.871, 1.554, 1.411, 1.332, 1.227, 1.238, 1.350, 1.548, 1.844, 2.923],
            [3.101, 2.800, 2.213, 1.861, 1.673, 1.562, 1.392, 1.396, 1.566, 1.864, 2.279, 3.734],
            [3.219, 3.029, 2.557, 2.204, 1.996, 1.859, 1.633, 1.637, 1.884, 2.291, 2.831, 4.592],
            [3.474, 3.319, 2.939, 2.623, 2.411, 2.262, 1.995, 2.013, 2.362, 2.919, 3.660, 5.656],
            [3.886, 3.783, 3.470, 3.199, 2.999, 2.849, 2.571, 2.624, 3.107, 3.858, 4.843, 7.087],
            [4.878, 4.619, 4.348, 4.126, 3.954, 3.823, 3.584, 3.714, 4.409, 5.480, 6.815, 8.878],
            [5.331, 5.267, 5.096, 4.864, 4.713, 4.608, 4.428, 4.635, 5.505, 6.856, 8.417, 10.46],
            [6.382, 6.375, 6.202, 5.963, 5.844, 5.776, 5.709, 6.032, 7.170, 8.833, 10.50, 12.38],
            [8.265, 8.215, 8.048, 7.806, 7.730, 7.709, 7.834, 8.415, 9.924, 11.61, 13.52, 15.20],
            [11.78, 11.58, 11.44, 11.21, 11.15, 11.18, 11.85, 13.09, 15.62, 17.89, 19.08, 20.53]
        ]
    },

    // Table C7: Stress Intensity Correction Factors (Pin Loading, Two Cracks, D/B=.1)
    C7: {
        cols: [0.0, 0.01, 0.05, 0.1, 0.15, 0.2, 0.4, 0.6, 0.8, 0.9, 0.95, 0.99],
        rows: [0.05, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.75, 0.80, 0.85, 0.90],
        data: [
            [.9805, .4561, .1712, .1093, .0871, .0764, .0651, .0683, .0760, .0833, .0957, .1464],
            [1.062, .6789, .3178, .2105, .1670, .1437, .1100, .1034, .1088, .1236, .1484, .2555],
            [1.243, .9941, .6056, .4355, .3553, .3090, .2337, .2169, .2362, .2583, .3598, .6158],
            [1.455, 1.278, .9093, .7004, .5889, .5204, .4036, .3812, .4299, .5310, .6719, 1.148],
            [1.733, 1.592, 1.255, 1.026, .8893, .7994, .6391, .6155, .7128, .8867, 1.117, 1.854],
            [2.089, 1.980, 1.680, 1.447, 1.294, 1.186, .9839, .9673, 1.141, 1.432, 1.815, 2.836],
            [2.609, 2.534, 2.258, 2.038, 1.879, 1.761, 1.532, 1.539, 1.828, 2.289, 2.888, 4.165],
            [3.522, 3.411, 3.174, 2.984, 2.830, 2.717, 2.499, 2.570, 3.054, 3.810, 4.751, 6.208],
            [4.188, 4.089, 3.928, 3.730, 3.593, 3.492, 3.313, 3.447, 4.097, 5.113, 6.293, 7.832],
            [5.214, 5.202, 5.022, 4.828, 4.720, 4.643, 4.557, 4.797, 5.699, 7.028, 8.366, 9.877],
            [7.085, 7.048, 6.895, 6.664, 6.589, 6.556, 6.666, 7.145, 8.529, 10.28, 11.67, 12.85],
            [10.53, 10.29, 10.30, 10.27, 10.20, 10.22, 10.81, 11.95, 14.30, 16.44, 17.82, 19.68]
        ]
    },

    // Table C8: Stress Intensity Correction Factors (Tension, Two Cracks at each Hole, .0055 <= D/B <= .1)
    C8: {
        cols: [0.0, 0.02, 0.05, 0.1, 0.15, 0.2, 0.4, 0.6, 0.8, 0.9, 0.95, 0.99],
        rows: [0.05, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.75, 0.80, 0.85, 0.90],
        data: [
            [2.890, 1.851, 1.452, 1.254, 1.184, 1.154, 1.155, 1.263, 1.526, 1.807, 2.552, 5.124],
            [2.895, 2.238, 1.789, 1.488, 1.362, 1.298, 1.250, 1.372, 1.711, 2.246, 2.980, 5.750],
            [2.957, 2.575, 2.220, 1.881, 1.697, 1.594, 1.450, 1.509, 1.809, 2.355, 3.225, 6.303],
            [3.051, 2.809, 2.528, 2.260, 2.023, 1.893, 1.693, 1.735, 2.115, 2.812, 3.858, 8.310],
            [3.216, 3.024, 2.822, 2.550, 2.360, 2.226, 1.987, 2.040, 2.596, 3.438, 4.611, 9.664],
            [3.483, 3.310, 3.157, 2.942, 2.779, 2.642, 2.417, 2.496, 3.040, 3.931, 5.470, 11.05],
            [3.864, 3.760, 3.629, 3.452, 3.295, 3.184, 2.970, 3.107, 3.879, 5.190, 7.204, 13.41],
            [4.658, 4.556, 4.514, 4.367, 4.160, 4.066, 3.902, 4.134, 5.178, 6.973, 9.601, 16.88],
            [5.305, 5.223, 5.158, 5.021, 4.881, 4.771, 4.643, 4.942, 6.207, 8.384, 11.37, 20.47],
            [6.494, 6.387, 6.363, 6.136, 6.053, 5.948, 5.788, 6.156, 7.515, 9.734, 13.07, 25.28],
            [8.523, 8.348, 8.124, 7.925, 7.901, 7.723, 7.634, 8.526, 10.65, 14.25, 19.55, 41.29],
            [12.50, 11.88, 11.69, 11.56, 11.37, 11.28, 11.69, 12.67, 15.77, 20.51, 27.60, 56.99]
        ]
    },

    // Table C9: Stress Intensity Correction Factors (Pin Loading, Two Cracks at each Hole, D/B=.1)
    C9: {
        cols: [0.0, 0.02, 0.05, 0.1, 0.15, 0.2, 0.4, 0.6, 0.8, 0.9, 0.95, 0.99],
        rows: [0.05, 0.10, 0.20, 0.30, 0.40, 0.50, 0.60, 0.70, 0.75, 0.80, 0.85, 0.90],
        data: [
            [.9945, .4588, .2724, .1730, .1328, .1113, .0795, .0739, .0857, .1125, .1530, .3326],
            [1.068, .6795, .4652, .3202, .2534, .2156, .1568, .1488, .1781, .2358, .3220, .6715],
            [1.259, .9958, .7936, .6112, .5116, .4492, .3447, .3328, .3995, .5278, .7261, 1.413],
            [1.471, 1.279, 1.103, .9158, .7991, .7202, .5790, .5655, .6798, .9013, 1.233, 2.654],
            [1.730, 1.599, 1.410, 1.261, 1.139, 1.049, .8780, .870, 1.069, 1.411, 1.886, 3.956],
            [2.104, 1.983, 1.848, 1.684, 1.563, 1.469, 1.283, 1.291, 1.565, 2.040, 2.716, 5.354],
            [2.596, 2.530, 2.408, 2.249, 2.131, 2.044, 1.853, 1.910, 2.361, 3.152, 4.370, 8.127],
            [3.487, 3.394, 3.329, 3.178, 3.036, 2.954, 2.794, 2.928, 3.652, 4.827, 5.901, 11.22],
            [4.116, 4.084, 4.007, 3.876, 3.761, 3.677, 3.538, 3.743, 4.685, 6.311, 8.401, 13.35],
            [5.283, 5.214, 5.185, 5.010, 4.866, 4.764, 4.607, 4.841, 5.884, 7.580, 11.11, 19.28],
            [7.208, 6.988, 6.880, 6.750, 6.665, 6.583, 6.598, 7.165, 8.934, 11.96, 16.41, 34.76],
            [11.11, 10.75, 10.53, 10.39, 10.22, 10.14, 10.40, 11.24, 13.99, 18.20, 24.50, 50.57]
        ]
    },

    // Table C10: Values of Coefficients B_{n,m}
    C10: {
        rows: [0, 1, 2, 3, 4, 5, 6, 7, 8],
        // Columns: B0, B1, B2, B3, B4 (m=0 to 4)
        data: [
            [6.2909E-3, -4.2720E-4, -8.4488E-4, -2.1989E-4, 9.3740E-5],
            [-3.7092E-2, 6.5214E-2, 6.7469E-2, 2.4756E-2, -1.8505E-2],
            [9.1764E-1, -9.7885E-1, -9.3965E-1, 3.3014E0, -3.6289E0],
            [-9.5339E-1, 1.3252E1, -6.4009E0, -1.5032E1, 4.2827E0],
            [-5.7380E0, -5.5698E1, 1.5976E1, 3.4969E1, 3.8805E1],
            [2.1452E1, 1.3165E2, -1.6777E1, -5.5679E1, -1.6295E2],
            [-3.6137E1, -1.8986E2, -1.5827E0, 2.7062E1, 4.3705E2],
            [3.0526E1, 1.4719E2, 5.3097E1, 4.5520E1, -5.5017E2],
            [-1.0024E1, -4.5487E1, -4.7418E1, -4.2747E1, 2.2008E2]
        ]
    }
};

/**
 * Piecewise Cubic Hermite Interpolating Polynomial (PCHIP)
 * Monotonically preserves shape, mathematically identical to scipy.interpolate.PchipInterpolator
 * @param {number[]} x - monotonically increasing x values
 * @param {number[]} y - corresponding y values
 * @param {number} x_eval - point to interpolate at
 * @returns {number} interpolated y value
 */
function pchip1D(x, y, x_eval) {
    const n = x.length;
    if (n < 2) return y[0];

    // 1. Calculate secant slopes h and deltas
    let h = new Float64Array(n - 1);
    let delta = new Float64Array(n - 1);
    for (let i = 0; i < n - 1; i++) {
        h[i] = x[i + 1] - x[i];
        delta[i] = (y[i + 1] - y[i]) / h[i];
    }

    // 2. Calculate derivatives S at the nodes
    let S = new Float64Array(n);

    // Function to calculate strictly monotonic S via Brodlie formula (same as SciPy)
    for (let i = 1; i < n - 1; i++) {
        if (delta[i - 1] * delta[i] > 0) {
            let w1 = 2 * h[i] + h[i - 1];
            let w2 = h[i] + 2 * h[i - 1];
            S[i] = (w1 + w2) / (w1 / delta[i - 1] + w2 / delta[i]);
        } else {
            S[i] = 0.0;
        }
    }

    // Endpoints (SciPy one-sided non-centered finite difference approach)
    S[0] = pchipEndDerivative(h[0], h[1], delta[0], delta[1]);
    S[n - 1] = pchipEndDerivative(h[n - 2], h[n - 3], delta[n - 2], delta[n - 3]);

    // 3. Evaluate
    if (x_eval <= x[0]) return y[0];
    if (x_eval >= x[n - 1]) return y[n - 1];

    for (let i = 0; i < n - 1; i++) {
        if (x_eval >= x[i] && x_eval <= x[i + 1]) {
            let dx = h[i];
            let t = (x_eval - x[i]) / dx;

            let t2 = t * t;
            let t3 = t2 * t;

            let h00 = 2 * t3 - 3 * t2 + 1;
            let h10 = t3 - 2 * t2 + t;
            let h01 = -2 * t3 + 3 * t2;
            let h11 = t3 - t2;

            return h00 * y[i] + h10 * dx * S[i] + h01 * y[i + 1] + h11 * dx * S[i + 1];
        }
    }
    return y[0];
}

/**
 * Helper to compute the PCHIP endpoint derivatives mirroring SciPy.
 */
function pchipEndDerivative(h0, h1, d0, d1) {
    if (d0 * d1 < 0) return 0.0;

    // Not-A-Knot type condition projected
    let val = ((2 * h0 + h1) * d0 - h0 * d1) / (h0 + h1);

    if (val * d0 < 0) return 0.0;
    return val;
}

/**
 * Bicubic PCHIP Interpolation for 2D table data.
 * @param {object} table - Table object with cols, rows, and data
 * @param {number} x - Column value (c/(H-D) or 2c/(H-D))
 * @param {number} y - Row value (D/H)
 * @returns {number} Interpolated value
 */
function interpolateTable(table, x, y) {
    // 1. Interpolate along the x-axis (columns) for each row via PCHIP
    const nRows = table.rows.length;
    let rowInterpVals = new Float64Array(nRows);

    for (let r = 0; r < nRows; r++) {
        rowInterpVals[r] = pchip1D(table.cols, table.data[r], x);
    }

    // 2. Interpolate along the y-axis (rows) using the evaluated points
    return pchip1D(table.rows, Array.from(rowInterpVals), y);
}

// Export for module or global usage
if (typeof module !== 'undefined' && module.exports) {
    module.exports = { TC05_DATA, interpolateTable };
}
