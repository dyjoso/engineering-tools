/**
 * Φ₁ FEM benchmark table for TC23 Solution B2 (in-plane bending).
 *
 * Φ₁(d₁, d₂) is the beta factor of a crack of size 2c₀ in a finite plate
 * under in-plane bending, at tip 1 as a function of both tip positions.
 *
 *   d₁ = (b − c₀)/W   (left edge to tip 1, normalized)
 *   d₂ = (b + c₀)/W   (left edge to tip 2, normalized)
 *
 * For tip 2:  β₂^{B2} = −Φ₁(1 − d₂, 1 − d₁)
 *
 * Source: NASGRO v8.2 Appendix C, TC23, page C-40/C-41.
 * Data obtained by FEM (finite element method).
 */

// Grid breakpoints (δ/W values)
const PHI1_GRID = [
    0.01, 0.03, 0.05, 0.10, 0.15, 0.20, 0.25, 0.30,
    0.35, 0.40, 0.45, 0.50, 0.55, 0.60, 0.65, 0.70,
    0.75, 0.80, 0.85, 0.90, 0.95, 0.97, 0.99
];

// PHI1_DATA[row][col] = Φ₁(δ₁/W, δ₂/W)
// Rows: δ₁/W,  Columns: δ₂/W  (same grid for both)
const PHI1_DATA = [
    // δ₂→  0.01    0.03    0.05    0.10    0.15    0.20    0.25    0.30    0.35    0.40    0.45    0.50    0.55    0.60    0.65    0.70    0.75    0.80    0.85    0.90    0.95    0.97    0.99
    /*0.01*/[0.980, 1.003, 1.016, 1.007, 0.980, 0.946, 0.908, 0.865, 0.816, 0.759, 0.694, 0.619, 0.535, 0.442, 0.340, 0.231, 0.114, -0.015, -0.162, -0.352, -0.689, -0.983, -1.867],
    /*0.03*/[1.059, 0.940, 0.924, 0.900, 0.866, 0.827, 0.782, 0.731, 0.674, 0.611, 0.542, 0.465, 0.383, 0.295, 0.202, 0.104, 0.000, -0.114, -0.245, -0.420, -0.743, -1.034, -1.927],
    /*0.05*/[1.158, 0.947, 0.900, 0.850, 0.809, 0.764, 0.714, 0.660, 0.600, 0.535, 0.465, 0.389, 0.309, 0.224, 0.136, 0.043, -0.055, -0.162, -0.287, -0.457, -0.778, -1.070, -1.977],
    /*0.10*/[1.353, 1.013, 0.909, 0.800, 0.735, 0.677, 0.619, 0.558, 0.495, 0.428, 0.357, 0.283, 0.206, 0.126, 0.044, -0.042, -0.133, -0.232, -0.352, -0.519, -0.844, -1.146, -2.091],
    /*0.15*/[1.508, 1.084, 0.942, 0.787, 0.700, 0.630, 0.564, 0.499, 0.433, 0.364, 0.293, 0.220, 0.144, 0.067, -0.013, -0.095, -0.183, -0.280, -0.399, -0.566, -0.899, -1.211, -2.190],
    /*0.20*/[1.645, 1.149, 0.977, 0.785, 0.681, 0.600, 0.528, 0.458, 0.389, 0.319, 0.247, 0.174, 0.099, 0.023, -0.055, -0.136, -0.223, -0.320, -0.438, -0.608, -0.949, -1.270, -2.274],
    /*0.25*/[1.774, 1.209, 1.011, 0.788, 0.668, 0.578, 0.500, 0.427, 0.355, 0.283, 0.211, 0.137, 0.063, -0.013, -0.091, -0.171, -0.257, -0.354, -0.474, -0.646, -0.993, -1.320, -2.339],
    /*0.30*/[1.897, 1.264, 1.042, 0.791, 0.658, 0.560, 0.477, 0.400, 0.326, 0.253, 0.179, 0.106, 0.031, -0.045, -0.122, -0.202, -0.288, -0.386, -0.506, -0.680, -1.031, -1.361, -2.381],
    /*0.35*/[2.014, 1.312, 1.068, 0.792, 0.647, 0.543, 0.456, 0.376, 0.300, 0.226, 0.151, 0.077, 0.003, -0.073, -0.151, -0.231, -0.317, -0.415, -0.535, -0.710, -1.062, -1.391, -2.398],
    /*0.40*/[2.122, 1.353, 1.087, 0.790, 0.636, 0.526, 0.435, 0.353, 0.276, 0.200, 0.125, 0.051, -0.024, -0.100, -0.177, -0.258, -0.344, -0.441, -0.561, -0.736, -1.085, -1.408, -2.389],
    /*0.45*/[2.217, 1.384, 1.100, 0.784, 0.622, 0.508, 0.414, 0.330, 0.250, 0.175, 0.100, 0.025, -0.050, -0.126, -0.203, -0.283, -0.369, -0.465, -0.585, -0.757, -1.099, -1.413, -2.354],
    /*0.50*/[2.296, 1.405, 1.104, 0.773, 0.605, 0.488, 0.392, 0.307, 0.228, 0.151, 0.075, 0.000, -0.075, -0.151, -0.228, -0.307, -0.392, -0.488, -0.605, -0.773, -1.104, -1.405, -2.296],
    /*0.55*/[2.354, 1.413, 1.099, 0.757, 0.585, 0.465, 0.369, 0.283, 0.203, 0.126, 0.050, -0.025, -0.100, -0.175, -0.253, -0.330, -0.414, -0.508, -0.622, -0.784, -1.100, -1.384, -2.217],
    /*0.60*/[2.389, 1.408, 1.085, 0.736, 0.561, 0.441, 0.344, 0.258, 0.177, 0.100, 0.024, -0.051, -0.125, -0.200, -0.276, -0.353, -0.435, -0.526, -0.636, -0.790, -1.087, -1.353, -2.122],
    /*0.65*/[2.398, 1.391, 1.062, 0.710, 0.535, 0.415, 0.317, 0.231, 0.151, 0.073, -0.003, -0.077, -0.151, -0.226, -0.300, -0.376, -0.456, -0.543, -0.647, -0.792, -1.068, -1.312, -2.014],
    /*0.70*/[2.381, 1.361, 1.031, 0.680, 0.506, 0.386, 0.288, 0.202, 0.122, 0.045, -0.031, -0.106, -0.179, -0.253, -0.326, -0.400, -0.477, -0.560, -0.658, -0.791, -1.042, -1.264, -1.897],
    /*0.75*/[2.339, 1.320, 0.993, 0.646, 0.474, 0.354, 0.257, 0.171, 0.091, 0.013, -0.063, -0.137, -0.211, -0.283, -0.355, -0.427, -0.500, -0.578, -0.668, -0.788, -1.011, -1.209, -1.774],
    /*0.80*/[2.274, 1.270, 0.949, 0.608, 0.438, 0.320, 0.223, 0.136, 0.055, -0.023, -0.099, -0.174, -0.247, -0.319, -0.389, -0.458, -0.528, -0.600, -0.681, -0.785, -0.977, -1.149, -1.645],
    /*0.85*/[2.190, 1.211, 0.899, 0.566, 0.399, 0.280, 0.183, 0.095, 0.013, -0.067, -0.144, -0.220, -0.293, -0.364, -0.433, -0.499, -0.564, -0.630, -0.700, -0.787, -0.942, -1.084, -1.508],
    /*0.90*/[2.091, 1.146, 0.844, 0.519, 0.352, 0.232, 0.133, 0.042, -0.044, -0.126, -0.206, -0.283, -0.357, -0.428, -0.495, -0.558, -0.619, -0.677, -0.735, -0.800, -0.909, -1.013, -1.353],
    /*0.95*/[1.977, 1.070, 0.778, 0.457, 0.287, 0.162, 0.055, -0.043, -0.136, -0.224, -0.309, -0.389, -0.465, -0.535, -0.600, -0.660, -0.714, -0.764, -0.809, -0.850, -0.900, -0.947, -1.158],
    /*0.97*/[1.927, 1.034, 0.743, 0.420, 0.245, 0.114, 0.000, -0.104, -0.202, -0.295, -0.383, -0.465, -0.542, -0.611, -0.674, -0.731, -0.782, -0.827, -0.866, -0.900, -0.924, -0.940, -1.059],
    /*0.99*/[1.867, 0.983, 0.689, 0.352, 0.162, 0.015, -0.114, -0.231, -0.340, -0.442, -0.535, -0.619, -0.694, -0.759, -0.816, -0.865, -0.908, -0.946, -0.980, -1.007, -1.016, -1.003, -0.980],
];

/**
 * Bilinear interpolation on the Φ₁ table.
 *
 * @param {number} d1 - Normalized distance from left edge to tip 1
 * @param {number} d2 - Normalized distance from left edge to tip 2
 * @returns {number}  Φ₁(d₁, d₂)
 */
function interpPhi1(d1, d2) {
    const g = PHI1_GRID;
    const n = g.length;

    // Clamp to grid range
    d1 = Math.max(g[0], Math.min(g[n - 1], d1));
    d2 = Math.max(g[0], Math.min(g[n - 1], d2));

    // Find bracketing indices for d1 (row)
    let i0 = 0;
    for (let i = 0; i < n - 1; i++) {
        if (g[i + 1] >= d1) { i0 = i; break; }
    }
    let i1 = Math.min(i0 + 1, n - 1);

    // Find bracketing indices for d2 (column)
    let j0 = 0;
    for (let j = 0; j < n - 1; j++) {
        if (g[j + 1] >= d2) { j0 = j; break; }
    }
    let j1 = Math.min(j0 + 1, n - 1);

    // Interpolation weights
    const tr = (i0 === i1) ? 0 : (d1 - g[i0]) / (g[i1] - g[i0]);
    const tc = (j0 === j1) ? 0 : (d2 - g[j0]) / (g[j1] - g[j0]);

    // Bilinear interpolation
    const v00 = PHI1_DATA[i0][j0];
    const v10 = PHI1_DATA[i1][j0];
    const v01 = PHI1_DATA[i0][j1];
    const v11 = PHI1_DATA[i1][j1];

    return v00 * (1 - tr) * (1 - tc)
        + v10 * tr * (1 - tc)
        + v01 * (1 - tr) * tc
        + v11 * tr * tc;
}

// Export for use by TC23
if (typeof window !== 'undefined') {
    window.interpPhi1 = interpPhi1;
}
